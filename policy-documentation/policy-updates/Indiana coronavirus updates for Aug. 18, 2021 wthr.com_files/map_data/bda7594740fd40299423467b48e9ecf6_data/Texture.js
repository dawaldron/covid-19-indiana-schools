// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/compilerUtils ../../../../core/Error ../../../../core/Evented ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/typedArrayUtil ../../../../core/urlUtils ../../../../support/requestImageUtils ../../../../support/requestUtils ./BasisUtil ./ContentObject ./DDSUtil ./glUtil3D ./Util ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util ../../../webgl/capabilities/isWebGL2Context".split(" "),
function(y,t,B,C,D,u,k,w,l,x,E,F,v,p,G,H,I,J,q,K,L){p=function(z){function h(a,c){var b=z.call(this)||this;b.data=a;b.type=4;b.glTexture=null;b.powerOfTwoStretchInfo=null;b.loadingPromise=null;b.loadingController=null;b.events=new D;b.params=c||{};b.params.mipmap=!1!==b.params.mipmap;b.params.noUnpackFlip=b.params.noUnpackFlip||!1;b.params.preMultiplyAlpha=b.params.preMultiplyAlpha||!1;b.params.wrap=b.params.wrap||{s:10497,t:10497};b.params.powerOfTwoResizeMode=b.params.powerOfTwoResizeMode||1;b.estimatedTexMemRequired=
h.estimateTexMemRequired(b.data,b.params);b.startPreload();return b}t._inheritsLoose(h,z);var g=h.prototype;g.startPreload=function(){const a=this.data;k.isNone(a)||(a instanceof HTMLVideoElement?this.startPreloadVideoElement(a):a instanceof HTMLImageElement&&this.startPreloadImageElement(a))};g.startPreloadVideoElement=function(a){x.isBlobProtocol(a.src)||"auto"===a.preload&&a.crossOrigin||(a.preload="auto",a.crossOrigin="anonymous",a.src=a.src)};g.startPreloadImageElement=function(a){x.isDataProtocol(a.src)||
x.isBlobProtocol(a.src)||a.crossOrigin||(a.crossOrigin="anonymous",a.src=a.src)};h.getDataDimensions=function(a){return a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a};h.estimateTexMemRequired=function(a,c){if(k.isNone(a))return 0;if(l.isArrayBuffer(a)||l.isUint8Array(a))return c.encoding===h.KTX2_ENCODING?v.estimateMemoryKTX2(a,c.mipmap):c.encoding===h.BASIS_ENCODING?v.estimateMemoryBasis(a,c.mipmap):a.byteLength;const {width:b,height:e}=a instanceof Image||a instanceof
ImageData||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?h.getDataDimensions(a):c;return(c.mipmap?4/3:1)*b*e*(c.components||4)||0};g.dispose=function(){this.data=void 0};g.createDescriptor=function(a){var c;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:null!=(c=this.params.maxAnisotropy)?c:
this.params.mipmap?a.parameters.maxMaxAnisotropy:1}};g.load=function(a,c){if(k.isSome(this.glTexture))return this.glTexture;if(k.isSome(this.loadingPromise))return this.loadingPromise;const b=this.data;return k.isNone(b)?this.glTexture=new q(a,this.createDescriptor(a),null):"string"===typeof b?this.loadFromURL(a,c,b):b instanceof Image?this.loadFromImageElement(a,c,b):b instanceof HTMLVideoElement?this.loadFromVideoElement(a,c,b):b instanceof ImageData||b instanceof HTMLCanvasElement?this.loadFromImage(a,
b,c):(l.isArrayBuffer(b)||l.isUint8Array(b))&&this.params.encoding===h.DDS_ENCODING?this.loadFromDDSData(a,b):(l.isArrayBuffer(b)||l.isUint8Array(b))&&this.params.encoding===h.KTX2_ENCODING?this.loadFromKTX2(a,b):(l.isArrayBuffer(b)||l.isUint8Array(b))&&this.params.encoding===h.BASIS_ENCODING?this.loadFromBasis(a,b):l.isUint8Array(b)?this.loadFromPixelData(a,b):l.isArrayBuffer(b)?this.loadFromPixelData(a,new Uint8Array(b)):null};g.frameUpdate=function(a,c,b){if(!(this.data instanceof HTMLVideoElement)||
k.isNone(this.glTexture)||2>this.data.readyState||b===this.data.currentTime)return b;if(k.isSome(this.powerOfTwoStretchInfo)){const {framebuffer:e,vao:f,sourceTexture:d}=this.powerOfTwoStretchInfo;d.setData(this.data);this.drawStretchedTexture(a,c,e,f,d,this.glTexture)}else{const {width:e,height:f}=this.data,{width:d,height:m}=this.glTexture.descriptor;e!==d||f!==m?this.glTexture.updateData(0,0,0,Math.min(e,d),Math.min(f,m),this.data):this.glTexture.setData(this.data)}this.glTexture.descriptor.hasMipmap&&
this.glTexture.generateMipmap();return this.data.currentTime};g.loadFromDDSData=function(a,c){return this.glTexture=G.createDDSTexture(a,this.createDescriptor(a),c)};g.loadFromKTX2=function(a,c){return this.loadAsync(()=>v.createTextureKTX2(a,this.createDescriptor(a),c).then(b=>this.glTexture=b))};g.loadFromBasis=function(a,c){return this.loadAsync(()=>v.createTextureBasis(a,this.createDescriptor(a),c).then(b=>this.glTexture=b))};g.loadFromPixelData=function(a,c){I.assert(0<this.params.width&&0<this.params.height);
const b=this.createDescriptor(a);b.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408;b.width=this.params.width;b.height=this.params.height;return this.glTexture=new q(a,b,c)};g.loadAsync=function(a){const c=w.createAbortController();this.loadingController=c;const b=a(c.signal);this.loadingPromise=b;a=()=>{this.loadingController===c&&(this.loadingController=null);this.loadingPromise===b&&(this.loadingPromise=null)};b.then(a,a);return b};g.loadFromURL=function(a,c,b){var e=
this;return this.loadAsync(function(){var f=t._asyncToGenerator(function*(d){d=yield E.requestImage(b,{signal:d});return e.loadFromImage(a,d,c)});return function(d){return f.apply(this,arguments)}}())};g.loadFromImageElement=function(a,c,b){var e=this;return b.complete?this.loadFromImage(a,b,c):this.loadAsync(function(){var f=t._asyncToGenerator(function*(d){d=yield F.loadImageAsync(b,b.src,!1,d);return e.loadFromImage(a,d,c)});return function(d){return f.apply(this,arguments)}}())};g.loadFromVideoElement=
function(a,c,b){return 2<=b.readyState?this.loadFromImage(a,b,c):this.loadFromVideoElementAsync(a,c,b)};g.loadFromVideoElementAsync=function(a,c,b){return this.loadAsync(e=>new Promise((f,d)=>{const m=()=>{b.removeEventListener("loadeddata",r);b.removeEventListener("error",n);k.isSome(A)&&A.remove()},r=()=>{2<=b.readyState&&(m(),f(this.loadFromImage(a,b,c)))},n=M=>{m();d(M||new C("Failed to load video"))};b.addEventListener("loadeddata",r);b.addEventListener("error",n);const A=w.onAbort(e,()=>n(w.createAbortError()))}))};
g.loadFromImage=function(a,c,b){const e=h.getDataDimensions(c);this.params.width=e.width;this.params.height=e.height;const f=this.createDescriptor(a);f.pixelFormat=3===this.params.components?6407:6408;if(this.requiresPowerOfTwo(a,f)&&(!u.isPowerOfTwo(e.width)||!u.isPowerOfTwo(e.height)))return this.glTexture=this.makePowerOfTwoTexture(a,c,e,f,b);f.width=e.width;f.height=e.height;return this.glTexture=new q(a,f,c)};g.requiresPowerOfTwo=function(a,c){const b="number"===typeof c.wrapMode?33071===c.wrapMode:
33071===c.wrapMode.s&&33071===c.wrapMode.t;return!L(a.gl)&&(c.hasMipmap||!b)};g.makePowerOfTwoTexture=function(a,c,b,e,f){const {width:d,height:m}=b;b=u.nextHighestPowerOfTwo(d);const r=u.nextHighestPowerOfTwo(m);e.width=b;e.height=r;let n;switch(this.params.powerOfTwoResizeMode){case 2:e.textureCoordinateScaleFactor=[d/b,m/r];n=new q(a,e);n.updateData(0,0,0,d,m,c);break;case 1:case null:case void 0:n=this.stretchToPowerOfTwo(a,c,e,f);break;default:B.neverReached(this.params.powerOfTwoResizeMode)}e.hasMipmap&&
n.generateMipmap();return n};g.stretchToPowerOfTwo=function(a,c,b,e){const f=new q(a,b),d=new J(a,{colorTarget:0,depthStencilTarget:0},f);c=new q(a,{target:3553,pixelFormat:b.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!b.flipped,maxAnisotropy:8,preMultiplyAlpha:b.preMultiplyAlpha},c);b=H.createQuadVAO(a);this.drawStretchedTexture(a,e,d,b,c,f);this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:b,sourceTexture:c,framebuffer:d}:(b.dispose(!0),c.dispose(),d.detachColorTexture(),
a.bindFramebuffer(null),d.dispose());return f};g.drawStretchedTexture=function(a,c,b,e,f,d){a.bindFramebuffer(b);b=a.getViewport();a.setViewport(0,0,d.descriptor.width,d.descriptor.height);d=c.program;a.useProgram(d);d.setUniform4f("color",1,1,1,1);d.bindTexture(f,"tex");a.bindVAO(e);a.setPipelineState(c.pipeline);a.drawArrays(5,0,K.vertexCount(e,"geometry"));a.bindFramebuffer(null);a.setViewport(b.x,b.y,b.width,b.height)};g.unload=function(){if(k.isSome(this.powerOfTwoStretchInfo)){const {framebuffer:a,
vao:c,sourceTexture:b}=this.powerOfTwoStretchInfo;c.dispose(!0);b.dispose();a.dispose();this.powerOfTwoStretchInfo=this.glTexture=null}k.isSome(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null);if(k.isSome(this.loadingController)){const a=this.loadingController;this.loadingPromise=this.loadingController=null;a.abort()}this.events.emit("unloaded")};t._createClass(h,[{key:"width",get:function(){return this.params.width}},{key:"height",get:function(){return this.params.height}},{key:"requiresFrameUpdates",
get:function(){return this.data instanceof HTMLVideoElement}}]);return h}(p.ContentObject);p.DDS_ENCODING="image/vnd-ms.dds";p.KTX2_ENCODING="image/ktx2";p.BASIS_ENCODING="image/x.basis";y.Texture=p;Object.defineProperty(y,"__esModule",{value:!0})});