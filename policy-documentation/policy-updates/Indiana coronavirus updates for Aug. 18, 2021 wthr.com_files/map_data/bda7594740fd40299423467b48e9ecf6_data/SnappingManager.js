// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Evented ../../../core/HandleOwner ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/accessorSupport/trackingUtils ../../../chunks/vec2 ../../../geometry/SpatialReference ./FeatureSnappingEngine ./SelfSnappingEngine ./SnappingOptions ./snappingUtils ./candidates/IntersectionSnappingCandidate".split(" "),
function(h,q,l,y,z,r,A,B,p,K,L,M,N,C,D,E,F,G,H,I,m,t){h.SnappingManager=function(w){function u(a){a=w.call(this,a)||this;a.options=new I;a.engines=[];a._currentMainCandidate=null;a._currentOtherActiveCandidates=[];return a}q._inheritsLoose(u,w);var g=u.prototype;g.initialize=function(){this.handles.add([D.reaction(()=>{const {effectiveFeatureEnabled:a,effectiveSelfEnabled:b,touchSensitivityMultiplier:c,distance:d}=this.options;return{effectiveFeatureEnabled:a,effectiveSelfEnabled:b,touchSensitivityMultiplier:c,
distance:d}},()=>{this.doneSnapping();this.emit("changed")}),this.watch("options",a=>{for(const b of this.engines)b.options=a},!0),B.init(this.view,"ready",a=>this.onViewReady(a),!0)])};g.destroy=function(){this.destroyEngines()};g.onViewReady=function(a){this.destroyEngines();if(a){var b,c;this.engines=[new H.SelfSnappingEngine({view:this.view,options:this.options}),new G.FeatureSnappingEngine({view:this.view,spatialReference:null!=(b=null==(c=this.view)?void 0:c.spatialReference)?b:F.WGS84,options:this.options})]}};
g.destroyEngines=function(){for(const a of this.engines)a.destroy();this.engines.length=0};g.snap=function(){var a=q._asyncToGenerator(function*(b,c,d){const e=c.coordinateHelper.fromPoint(b),f=yield this.fetchCandidates(e,c,d);return{get valid(){return!A.isAborted(d)},apply:()=>{const {snappedPoint:n,hints:k}=this.processCandidates(e,f,c);this.removeVisualization();r.isSome(c.visualizer)&&this.handles.add(c.visualizer.draw(k,{coordinateHelper:c.coordinateHelper,elevationInfo:c.elevationInfo,view:this.view}),
"visualization-handle");return n}}});return function(b,c,d){return a.apply(this,arguments)}}();g.update=function(a,b){this.removeVisualization();let c=a;const d=[];if(r.isSome(this._currentMainCandidate)){const e=b.coordinateHelper;a=e.fromPoint(a);const f=this._currentMainCandidate.constraint.closestTo(a);if(m.squareDistance(m.anyMapPointToScreenPoint(a,e,b.elevationInfo,this.view),m.anyMapPointToScreenPoint(f,e,b.elevationInfo,this.view))<this.squaredPointProximityThreshold(b.pointer)){c=e.createDehydratedPoint(f);
this._currentMainCandidate.targetPoint=f;d.push(...this._currentMainCandidate.hints);for(const n of this._currentOtherActiveCandidates)n.targetPoint=f,d.push(...n.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}r.isSome(b.visualizer)&&this.handles.add(b.visualizer.draw(d,{coordinateHelper:b.coordinateHelper,elevationInfo:b.elevationInfo,view:this.view}),"visualization-handle");return c};g.doneSnapping=function(){this.removeVisualization();this._currentMainCandidate=
null;this._currentOtherActiveCandidates=[]};g.removeVisualization=function(){this.handles.remove("visualization-handle")};g.fetchCandidates=function(){var a=q._asyncToGenerator(function*(b,c,d){return(yield Promise.all(this.engines.map(e=>e.fetchCandidates(b,c,d)))).flat()});return function(b,c,d){return a.apply(this,arguments)}}();g.processCandidates=function(a,b,c){if(1>b.length)return this.doneSnapping(),{snappedPoint:c.coordinateHelper.createDehydratedPoint(a),hints:[]};m.sortCandidatesInPlace(a,
b);const d=this._currentMainCandidate;if(r.isSome(d)){const e=this.findOldConstraintInNewCandidates(d,b);if(0<=e)if(b[e]instanceof t.IntersectionSnappingCandidate){if(E.squaredDistance(a,d.targetPoint)<this.squaredPointProximityThreshold(c.pointer))return this.updateSnappingCandidate(d,b,c)}else return this.intersectWithOtherCandidates(e,b,a,c)}return this.intersectWithOtherCandidates(0,b,a,c)};g.findOldConstraintInNewCandidates=function(a,b){return a instanceof t.IntersectionSnappingCandidate?0<=
this.findOldCandidateIndex(b,a.first)&&0<=this.findOldCandidateIndex(b,a.second)?0:-1:this.findOldCandidateIndex(b,a)};g.intersectWithOtherCandidates=function(a,b,c,d){const e=b[a],f=[],n=d.coordinateHelper;for(let k=0;k<b.length;++k){if(k===a)continue;const v=b[k];for(const J of e.constraint.intersect(v.constraint)){const x=n.fromXYZ(J.intersection,e.targetPoint[2]);f.push([new t.IntersectionSnappingCandidate(n,x,e,v),m.squareDistance(m.anyMapPointToScreenPoint(c,d.coordinateHelper,d.elevationInfo,
this.view),m.anyMapPointToScreenPoint(x,d.coordinateHelper,d.elevationInfo,this.view))])}}return 0<f.length&&(f.sort((k,v)=>k[1]-v[1]),f[0][1]<this.squaredPointProximityThreshold(d.pointer))?this.updateSnappingCandidate(f[0][0],b,d):this.updateSnappingCandidate(e,b,d)};g.updateSnappingCandidate=function(a,b,c){this.doneSnapping();this._currentMainCandidate=a;const d=this._currentMainCandidate.targetPoint,e=[];e.push(...a.hints);for(const f of b){if(a instanceof t.IntersectionSnappingCandidate){if(f.constraint.objectEqual(a.first.constraint)||
f.constraint.objectEqual(a.second.constraint))continue}else if(f.constraint.objectEqual(a.constraint))continue;f.constraint.check(d)&&(f.targetPoint=d,this._currentOtherActiveCandidates.push(f),e.push(...f.hints))}return{snappedPoint:c.coordinateHelper.createDehydratedPoint(d),hints:e}};g.squaredPointProximityThreshold=function(a){return"touch"===a?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold};g.findOldCandidateIndex=function(a,b){let c=-1;for(let d=0;d<a.length;++d)if(b.constraint.objectEqual(a[d].constraint)){c=
d;break}return c};q._createClass(u,[{key:"updating",get:function(){return this.engines.some(a=>a.updating)}},{key:"squaredMouseProximityTreshold",get:function(){return this.options.distance*this.options.distance}},{key:"squaredTouchProximityThreshold",get:function(){const {distance:a,touchSensitivityMultiplier:b}=this.options,c=a*b;return c*c}},{key:"test",get:function(){return{visualizationsActive:this.handles.has("visualization-handle"),engines:this.engines}}}]);return u}(y.EventedMixin(z.HandleOwner));
l.__decorate([p.property({constructOnly:!0})],h.SnappingManager.prototype,"view",void 0);l.__decorate([p.property()],h.SnappingManager.prototype,"options",void 0);l.__decorate([p.property({readOnly:!0})],h.SnappingManager.prototype,"updating",null);l.__decorate([p.property()],h.SnappingManager.prototype,"engines",void 0);l.__decorate([p.property()],h.SnappingManager.prototype,"squaredMouseProximityTreshold",null);l.__decorate([p.property()],h.SnappingManager.prototype,"squaredTouchProximityThreshold",
null);h.SnappingManager=l.__decorate([C.subclass("esri.views.interactive.snapping.SnappingManager")],h.SnappingManager);Object.defineProperty(h,"__esModule",{value:!0})});