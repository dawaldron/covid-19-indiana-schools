// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/HandleOwner ../../../core/Handles ../../../core/MapUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3f64 ./SnappingConstraint ./snappingUtils ./candidates/EdgeSnappingCandidate ./candidates/FeatureSnappingCandidate ./candidates/RightAngleSnappingCandidate".split(" "),
function(x,n,y,r,C,D,E,g,z,A,t,O,P,Q,R,F,G,H,v,I,J,K){n.FeatureSnappingEngine=function(u){function l(a){a=u.call(this,a)||this;a.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}};return a}y._inheritsLoose(l,u);var f=l.prototype;f.initialize=function(){this.updatingHandles.add(this,"snappingSources",()=>{this.notifyChange("updating")},1);if(g.isSome(this.view)){var a;this.handles.add([null==(a=this.view.refreshManager)?
void 0:a.on("refresh",b=>{"interval"===b.trigger&&this.refreshSourceOfLayer(b.layerView.layer)}),this.view.on("layerview-create",b=>this.updateLayerView(b.layer,b.layerView)),this.view.on("layerview-destroy",b=>this.updateLayerView(b.layer,null))])}};f.refreshSourceOfLayer=function(a){for(const [,{snappingSource:b}]of this.snappingSources)b.layerSource.layer===a&&b.refresh()};f.updateLayerView=function(a,b){for(const [,c]of this.snappingSources)c.snappingSource.layerSource.layer===a&&(c.layerView=
b)};f.destroy=function(){this._set("options",null);for(const [,a]of this.snappingSources)a.destroy()};f.fetchCandidates=function(){var a=y._asyncToGenerator(function*(b,c,d){if(!this.options.effectiveFeatureEnabled)return[];var e=[];const k=this.computeScreeenSizeDistanceParameters(b,c),h={distance:k,point:b,coordinateHelper:c.coordinateHelper,types:this.types,filter:null};for(const [,{snappingSource:m,layerView:q}]of this.snappingSources)!m.layerSource.enabled||g.isSome(q)&&q.suspended||e.push(m.fetchCandidates(h,
d).then(p=>p.filter(w=>!this.candidateIsExcluded(m,w,c.excludeFeature))));e=(yield z.eachAlwaysValues(e)).flat();this.addRightAngleCandidates(e,b,k,c);z.throwIfAborted(d);v.sortCandidatesInPlace(b,e);return e});return function(b,c,d){return a.apply(this,arguments)}}();f.addRightAngleCandidates=function(a,b,c,d){var e,k,h,m,q,p,w,B;const L=g.isSome(d.vertexHandle)?null==(e=d.vertexHandle.right)?void 0:null==(k=e.right)?void 0:k.pos:g.isSome(d.geometry)&&"polygon"===d.geometry.type?null==(h=g.unwrap(null==
(m=d.geometry.editGeometry.components[0])?void 0:m.getFirstVertex()))?void 0:h.pos:null;e=g.isSome(d.vertexHandle)?null==(q=d.vertexHandle.left)?void 0:null==(p=q.left)?void 0:p.pos:g.isSome(d.geometry)?null==(w=g.unwrap(null==(B=d.geometry.editGeometry.components[0])?void 0:B.getLastVertex()))?void 0:w.pos:null;q=a.length;for(p=0;p<q;p++)this.addRightAngleCandidate(a[p],e,b,c,d,a),this.addRightAngleCandidate(a[p],L,b,c,d,a)};f.addRightAngleCandidate=function(a,b,c,d,e,k){if(!g.isNone(b)&&a instanceof
I.EdgeSnappingCandidate){var h=a.constraint.closestTo(b),m=(h[0]-c[0])/d.x;c=(h[1]-c[1])/d.y;1>=m*m+c*c&&(e=e.coordinateHelper,k.push(new K.RightAngleSnappingCandidate({coordinateHelper:e,targetPoint:h,otherVertex:b,otherVertexType:0,previousVertex:a.constraint.start,constraint:new H.RayConstraint(e,b,h),objectId:a.objectId})))}};f.computeScreeenSizeDistanceParameters=function(a,b){const c=this.options.distance*("touch"===b.pointer?this.options.touchSensitivityMultiplier:1);return g.isNone(this.view)?
{x:c,y:c}:"2d"===this.view.type?{x:c*this.view.resolution,y:c*this.view.resolution}:this.computeScreeenSizeDistanceParameters3D(a,c,this.view,b)};f.computeScreeenSizeDistanceParameters3D=function(a,b,c,d){const {coordinateHelper:e,elevationInfo:k}=d,h=c.state.camera.computeScreenPixelSizeAt(v.anyMapPointToRender(a,e,k,c,M))*c.renderCoordsHelper.unitInMeters/c.mapCoordsHelper.unitInMeters;b*=h;const m=this.computeScreenMagnitudeOfMapOffset(a,h,0,c,d);a=this.computeScreenMagnitudeOfMapOffset(a,0,h,
c,d);return{x:b/m,y:b/a}};f.computeScreenMagnitudeOfMapOffset=function(a,b,c,d,{coordinateHelper:e,elevationInfo:k}){const h=e.clone(a);h[0]+=b;h[1]+=c;a=v.anyMapPointToScreenPoint(a,e,k,d);e=v.anyMapPointToScreenPoint(h,e,k,d);d=e.x-a.x;e=e.y-a.y;return Math.sqrt(d*d+e*e)};f.candidateIsExcluded=function(a,b,c){if(g.isNone(c))return!1;b=this.getCandidateObjectId(b);if(g.isNone(b))return!1;a=a.layerSource.layer;return"graphics"===a.type?c.uid===b:c.sourceLayer===a&&c.attributes&&"objectIdField"in a?
c.attributes[a.objectIdField]===b:!1};f.getCandidateObjectId=function(a){return a instanceof J.FeatureSnappingCandidate?a.objectId:null};f.createSourceInfo=function(a){const b=this.createFeatureSnappingSourceType(a);if(g.isNone(b))return null;if("loading"in b)return this.updatingHandles.addPromise(b.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const c=g.isSome(this.view)?this.view.allLayerViews.find(d=>d.layer===a.layer):null;return new N(b.source,c)};f.createFeatureSnappingSourceType=
function(a){switch(a.layer.type){case "feature":case "geojson":case "csv":case "wfs":return this.createFeatureSnappingSourceFeatureLayer(a);case "graphics":return this.createFeatureSnappingSourceGraphicsLayer(a)}return null};f.createFeatureSnappingSourceFeatureLayer=function(a){switch(a.layer.source.type){case "feature-layer":var b=this.getSourceModule("featureService");return g.isSome(b.module)?{source:new b.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,
layerSource:a})}:{loading:b.loader};case "memory":case "csv":case "geojson":case "wfs":if("mesh"!==a.layer.geometryType)return b=this.getSourceModule("featureCollection"),g.isSome(b.module)?{source:new b.module.FeatureCollectionSnappingSource({layerSource:a})}:{loading:b.loader}}return null};f.createFeatureSnappingSourceGraphicsLayer=function(a){const b=this.getSourceModule("graphics");return g.isSome(b.module)?{source:new b.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,
layerSource:a})}:{loading:b.loader}};f.getSourceModule=function(a){const b=this.sourceModules[a];return g.isNone(b.loader)?(a=this.loadSourceModule(a).then(c=>{b.module=c}),b.loader=a,{module:b.module,loader:a}):{module:b.module,loader:b.loader}};f.loadSourceModule=function(a){switch(a){case "featureService":return this.updatingHandles.addPromise(new Promise(function(b,c){x(["./featureSources/FeatureServiceSnappingSource"],b,c)}));case "featureCollection":return this.updatingHandles.addPromise(new Promise(function(b,
c){x(["./featureSources/FeatureCollectionSnappingSource"],b,c)}));case "graphics":return this.updatingHandles.addPromise(new Promise(function(b,c){x(["./featureSources/GraphicsSnappingSource"],b,c)}))}return null};y._createClass(l,[{key:"updating",get:function(){return E.someMap(this.snappingSources,({snappingSource:a})=>a.updating)||this.updatingHandles.updating}},{key:"snappingSources",get:function(){var a;const b=this._get("snappingSources")||new Map,c=new Map;if(null!=(a=this.options)&&a.featureSources)for(const e of this.options.featureSources.items){a=
e.layer.uid;var d=b.get(a);d?(b.delete(a),c.set(a,d)):e.layer.loaded?(d=this.createSourceInfo(e),g.isSome(d)&&c.set(a,d)):this.updatingHandles.addPromise(e.layer.load())}for(const [,e]of b)e.destroy();return c}},{key:"types",get:function(){return 3}}]);return l}(C.HandleOwner);r.__decorate([t.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,"spatialReference",void 0);r.__decorate([t.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,"view",void 0);r.__decorate([t.property()],
n.FeatureSnappingEngine.prototype,"options",void 0);r.__decorate([t.property({readOnly:!0})],n.FeatureSnappingEngine.prototype,"updating",null);r.__decorate([t.property({readOnly:!0})],n.FeatureSnappingEngine.prototype,"snappingSources",null);n.FeatureSnappingEngine=r.__decorate([F.subclass("esri.views.interactive.snapping.FeatureSnappingEngine")],n.FeatureSnappingEngine);let N=function(){function u(l,f){this.snappingSource=l;this.layerView=f;this.handles=new D;f=this.snappingSource.layerSource.layer;
"refresh"in f&&this.handles.add(f.on("refresh",()=>l.refresh()));this.handles.add([A.init(l,"updating",a=>l.layerSource.updating=a,!0),A.init(l,"availability",a=>l.layerSource.availability=a,!0)])}u.prototype.destroy=function(){this.snappingSource.destroy();this.handles.destroy()};return u}();const M=G.create();Object.defineProperty(n,"__esModule",{value:!0})});