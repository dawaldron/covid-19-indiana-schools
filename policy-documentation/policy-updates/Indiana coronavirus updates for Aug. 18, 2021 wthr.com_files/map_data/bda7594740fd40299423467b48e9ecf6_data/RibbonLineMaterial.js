// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../support/buffer/InterleavedLayout ../lib/geometryDataUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./VisualVariableMaterialParameters ./renderers/utils ../shaders/RibbonLineTechnique".split(" "),
function(aa,ba,P,Q,O,K,ja,l,x,G,r,ka,la,ma,ca,na,oa,pa,R){function S(B,u,c,a,b){for(let g=0;g<b;g++)c[a++]=B[u++];return a}function T(B,u,c){u=u.get("position").data;c=c?c.get("position"):null;return B.isClosed?c?2<c.length:6<u.length:!1}const qa=P.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");P=function(B){function u(a){a=B.call(this,a,ra)||this;a._vertexAttributeLocations=R.ribbonVertexAttributeLocations;a.techniqueConfig=new R.RibbonLineTechniqueConfiguration;a.layout=a.createLayout();
return a}ba._inheritsLoose(u,B);var c=u.prototype;c.isClosed=function(a,b){return this.params.isClosed?b?2<b.length:6<a.length:!1};c.dispose=function(){};c.getPassParameters=function(){return this.params};c.getTechniqueConfig=function(a,b){this.techniqueConfig.output=a;a=O.isSome(this.params.stipplePattern);this.techniqueConfig.stippleEnabled=a;this.techniqueConfig.stippleIntegerRepeatsEnabled=a&&this.params.stippleIntegerRepeats;this.techniqueConfig.stippleOffColorEnabled=a&&O.isSome(this.params.stippleOffColor);
this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees;this.techniqueConfig.roundJoins="round"===this.params.join;this.techniqueConfig.roundCaps="round"===this.params.cap;this.techniqueConfig.transparent=this.params.transparent;this.techniqueConfig.polygonOffset=this.params.polygonOffset;this.techniqueConfig.writeDepth=this.params.writeDepth;this.techniqueConfig.vvColor=this.params.vvColorEnabled;this.techniqueConfig.vvOpacity=
this.params.vvOpacityEnabled;this.techniqueConfig.vvSize=this.params.vvSizeEnabled;this.techniqueConfig.innerColorEnabled=0<this.params.innerWidth&&O.isSome(this.params.innerColor);this.techniqueConfig.falloffEnabled=0<this.params.falloff;this.techniqueConfig.occluder=8===this.params.renderOccluded;this.techniqueConfig.transparencyPassType=b?b.transparencyPassType:3;this.techniqueConfig.multipassTerrainEnabled=b?b.multipassTerrainEnabled:!1;this.techniqueConfig.cullAboveGround=b?b.cullAboveGround:
!1;return this.techniqueConfig};c.intersect=function(a,b,g,f,d,h,e,k,q){q?this.intersectDrapedLineGeometry(a,f,h,e):this.intersectLineGeometry(a,b,g,f,this.params.width,e)};c.intersectDrapedLineGeometry=function(a,b,g,f){if(b.options.selectionMode){b=a.vertexAttributes.get("position").data;var d=a.vertexAttributes.get("size"),h=this.params.width;this.params.vvSizeEnabled?(d=a.vertexAttributes.get("sizeFeatureAttribute").data[0],h*=Q.clamp(this.params.vvSizeOffset[0]+d*this.params.vvSizeFactor[0],
this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])):d&&(h*=d.data[0]);d=g[0];g=g[1];a=(h/2+4)*a.screenToWorldRatio;h=Number.MAX_VALUE;for(let n=0;n<b.length-5;n+=3){var e=b[n],k=b[n+1],q=d-e,t=g-k;e=b[n+3]-e;k=b[n+4]-k;const E=Q.clamp((e*q+k*t)/(e*e+k*k),0,1);q=e*E-q;t=k*E-t;t=q*q+t*t;t<h&&(h=t)}h<a*a&&f()}};c.intersectLineGeometry=function(a,b,g,f,d,h){if(f.options.selectionMode&&!pa.isInstanceHidden(b))if(na.isTranslationMatrix(g)){var e=a.vertexAttributes;b=e.get("position").data;if(this.params.vvSizeEnabled){var k=
e.get("sizeFeatureAttribute").data[0];d*=Q.clamp(this.params.vvSizeOffset[0]+k*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else e.has("size")&&(d*=e.get("size").data[0]);k=f.camera;var q=sa;ja.copy(q,f.point);d=d*k.pixelRatio/2+4*k.pixelRatio;l.set(N[0],q[0]-d,q[1]+d,0);l.set(N[1],q[0]+d,q[1]+d,0);l.set(N[2],q[0]+d,q[1]-d,0);l.set(N[3],q[0]-d,q[1]-d,0);for(var t=0;4>t;t++)if(!k.unprojectFromRenderScreen(N[t],F[t]))return;r.fromPoints(k.eye,F[0],F[1],U);r.fromPoints(k.eye,
F[1],F[2],V);r.fromPoints(k.eye,F[2],F[3],W);r.fromPoints(k.eye,F[3],F[0],X);t=Number.MAX_VALUE;a=T(this.params,e,a.indices)?b.length-2:b.length-5;for(e=0;e<a;e+=3){v[0]=b[e]+g[12];v[1]=b[e+1]+g[13];v[2]=b[e+2]+g[14];var n=(e+3)%b.length;w[0]=b[n]+g[12];w[1]=b[n+1]+g[13];w[2]=b[n+2]+g[14];if(!(0>r.signedDistance(U,v)&&0>r.signedDistance(U,w)||0>r.signedDistance(V,v)&&0>r.signedDistance(V,w)||0>r.signedDistance(W,v)&&0>r.signedDistance(W,w)||0>r.signedDistance(X,v)&&0>r.signedDistance(X,w))){k.projectToRenderScreen(v,
H);k.projectToRenderScreen(w,I);if(0>H[2]&&0<I[2])l.subtract(D,v,w),n=k.frustum,n=-r.signedDistance(n[4],v)/l.dot(D,r.normal(n[4])),l.scale(D,D,n),l.add(v,v,D),k.projectToRenderScreen(v,H);else if(0<H[2]&&0>I[2])l.subtract(D,w,v),n=k.frustum,n=-r.signedDistance(n[4],w)/l.dot(D,r.normal(n[4])),l.scale(D,D,n),l.add(w,w,D),k.projectToRenderScreen(w,I);else if(0>H[2]&&0>I[2])continue;H[2]=0;I[2]=0;n=G.distance2(G.fromPoints(H,I,da),q);n<t&&(t=n,l.copy(ea,v),l.copy(fa,w))}}g=f.rayBeginPoint;f=f.rayEndPoint;
t<d*d&&(b=Number.MAX_VALUE,G.closestLineSegmentPoint(G.fromPoints(ea,fa,da),G.fromPoints(g,f,ta),J)&&(l.subtract(J,J,g),b=l.length(J),l.scale(J,J,1/b),b/=l.distance(g,f)),h(b,J))}else qa.error("intersection assumes a translation-only matrix")};c.computeAttachmentOrigin=function(a,b){const g=a.vertexAttributes;if(!g)return null;a=a.indices;const f=g.get("position");return la.computeAttachmentOriginLines(f,a?a.get("position"):null,a&&T(this.params,g,a),b)};c.createLayout=function(){const a=ka.newLayout().vec3f("position").f32("subdivisionFactor").vec2f("uv0").vec3f("auxpos1").vec3f("auxpos2");
this.params.vvSizeEnabled?a.f32("sizeFeatureAttribute"):a.f32("size");this.params.vvColorEnabled?a.f32("colorFeatureAttribute"):a.vec4f("color");this.params.vvOpacityEnabled&&a.f32("opacityFeatureAttribute");return a};c.createBufferWriter=function(){return new ua(this.layout,this.params)};c.getGLMaterial=function(a){return 0===a.output||7===a.output||4===a.output||1===a.output?new va(a):void 0};c.validateParameterValues=function(a){"miter"!==a.join&&(a.miterLimit=0);this.requiresTransparent(a)&&(a.transparent=
!0)};c.requiresTransparent=function(a){return!!(1>(a.color&&a.color[3])||0<a.innerWidth&&this.colorRequiresTransparent(a.innerColor)||a.stipplePattern&&this.colorRequiresTransparent(a.stippleOffColor)||0<a.falloff)};c.colorRequiresTransparent=function(a){return O.isSome(a)&&1>a[3]&&0<a[3]};return u}(ca.Material);let va=function(B){function u(a){a=B.call(this,a)||this;a.updateParameters();return a}ba._inheritsLoose(u,B);var c=u.prototype;c.updateParameters=function(a){this._technique=this._techniqueRep.releaseAndAcquire(R.RibbonLineTechnique,
this._material.getTechniqueConfig(this._output,a),this._technique)};c.beginSlot=function(a){return this._technique.configuration.occluder?3===a||10===a||11===a:0===this._output||7===this._output?(this.targetSlot=this._technique.configuration.writeDepth?5:8,a===this.targetSlot):3===a};c._updateOccludeeState=function(a){a.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:a.hasOccludees})};c.ensureParameters=function(a){0!==this._output&&7!==this._output||
this._updateOccludeeState(a);this.updateParameters(a)};c.bind=function(a){this._technique.bindPass(this._material.getPassParameters(),a)};c.getPipelineState=function(a,b){return this._technique.getPipelineState(a,b)};return u}(ma);const ra={width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,
sceneHasOcludees:!1,...ca.materialParametersDefaults,...oa.Default};let ua=function(){function B(c,a){this.params=a;this.numJoinSubdivisions=0;this.vertexBufferLayout=c;switch(this.params.join){case "miter":case "bevel":this.numJoinSubdivisions=a.stipplePattern?1:0;break;case "round":this.numJoinSubdivisions=1}}var u=B.prototype;u.isClosed=function(c){return T(this.params,c.vertexAttributes,c.indices)};u.numCapSubdivisions=function(c){if(this.isClosed(c))return 0;switch(this.params.cap){case "butt":return 0;
case "square":return 1;case "round":return 3}};u.allocate=function(c){return this.vertexBufferLayout.createBuffer(c)};u.elementCount=function(c){var a=2*this.numCapSubdivisions(c)+2,b=c.indices.get("position").length/2+1;const g=this.isClosed(c);a=g?2:2*a;var f=g?0:1;b=g?b:b-1;if(c.vertexAttributes.has("subdivisions"))for(c=c.vertexAttributes.get("subdivisions").data;f<b;++f)a+=4+2*c[f];else a+=(b-f)*(2*this.numJoinSubdivisions+4);return a+2};u.write=function(c,a,b,g){const f=wa,d=xa,h=ya;var e=a.vertexAttributes.get("position").data,
k=a.indices&&a.indices.get("position");const q=this.numCapSubdivisions(a);k&&k.length!==2*(e.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");k=null;a.vertexAttributes.has("subdivisions")&&(k=a.vertexAttributes.get("subdivisions").data);let t=1,n=0;this.params.vvSizeEnabled?n=a.vertexAttributes.get("sizeFeatureAttribute").data[0]:a.vertexAttributes.has("size")&&(t=a.vertexAttributes.get("size").data[0]);let E=[1,1,1,1],ha=0;this.params.vvColorEnabled?ha=a.vertexAttributes.get("colorFeatureAttribute").data[0]:
a.vertexAttributes.has("color")&&(E=a.vertexAttributes.get("color").data);let ia=0;this.params.vvOpacityEnabled&&(ia=a.vertexAttributes.get("opacityFeatureAttribute").data[0]);const Y=e.length/3;c=c.transformation;const p=new Float32Array(b.buffer);b=this.vertexBufferLayout.stride/4;let m=g*b;g=m;const y=(C,L,Z,za,Aa,Ba,Ca)=>{p[m++]=L[0];p[m++]=L[1];p[m++]=L[2];p[m++]=za;p[m++]=Aa;p[m++]=Ba;p[m++]=C[0];p[m++]=C[1];p[m++]=C[2];p[m++]=Z[0];p[m++]=Z[1];p[m++]=Z[2];this.params.vvSizeEnabled?p[m++]=n:
p[m++]=t;this.params.vvColorEnabled?p[m++]=ha:(C=Math.min(4*Ca,E.length-4),p[m++]=E[C+0],p[m++]=E[C+1],p[m++]=E[C+2],p[m++]=E[C+3]);this.params.vvOpacityEnabled&&(p[m++]=ia)};m+=b;l.set(d,e[0],e[1],e[2]);c&&l.transformMat4(d,d,c);if(a=this.isClosed(a)){var z=e.length-3;l.set(f,e[z],e[z+1],e[z+2]);c&&l.transformMat4(f,f,c)}else{l.copy(f,d);l.set(h,e[3],e[4],e[5]);c&&l.transformMat4(h,h,c);for(z=0;z<q;++z){var A=1-z/q;y(f,d,h,A,1,-4,0);y(f,d,h,A,1,4,0)}y(f,d,h,0,0,-4,0);y(f,d,h,0,0,4,0);l.copy(f,d);
l.copy(d,h)}A=a?0:1;for(z=a?Y:Y-1;A<z;A++){var M=(A+1)%Y*3;l.set(h,e[M+0],e[M+1],e[M+2]);c&&l.transformMat4(h,h,c);y(f,d,h,0,1,-1,A);y(f,d,h,0,1,1,A);M=k?k[A]:this.numJoinSubdivisions;for(let C=0;C<M;++C){const L=(C+1)/(M+1);y(f,d,h,L,1,-2,A);y(f,d,h,L,1,2,A)}y(f,d,h,1,0,-2,A);y(f,d,h,1,0,2,A);l.copy(f,d);l.copy(d,h)}if(a)m=S(p,g+b,p,m,2*b);else for(y(f,d,h,0,1,-5,z),y(f,d,h,0,1,5,z),e=0;e<q;++e)k=(e+1)/q,y(f,d,h,k,1,-5,z),y(f,d,h,k,1,5,z);S(p,g+b,p,g,b);m=S(p,m-b,p,m,b)};return B}();const v=x.create(),
w=x.create(),D=x.create(),J=x.create(),sa=x.create(),H=K.createRenderScreenPointArray3(),I=K.createRenderScreenPointArray3(),ea=x.create(),fa=x.create(),da=G.create(),ta=G.create(),wa=x.create(),xa=x.create(),ya=x.create(),N=[K.createRenderScreenPointArray3(),K.createRenderScreenPointArray3(),K.createRenderScreenPointArray3(),K.createRenderScreenPointArray3()],F=[x.create(),x.create(),x.create(),x.create()],U=r.create(),V=r.create(),W=r.create(),X=r.create();aa.RibbonLineMaterial=P;Object.defineProperty(aa,
"__esModule",{value:!0})});