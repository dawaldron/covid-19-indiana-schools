// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../core/libs/gl-matrix-2/types/mat4 ../../../../geometry/support/aaBoundingRect ../../support/buffer/InterleavedLayout ../lib/geometryDataUtils ../lib/GLMaterialTexture ../lib/Material ../lib/screenSizePerspectiveUtils ../lib/Util ./internal/bufferWriterUtils ./internal/MaterialUtil ./renderers/utils ../../../../chunks/HUDMaterial.glsl ../shaders/HUDMaterialTechnique".split(" "),
function(S,G,M,N,da,T,U,ea,V,fa,W,k,C,ha,ia,ja,ka,J,X,K,la,H,ma,na,Y,L){function oa(q,l,f,a=pa){fa.copy(a,q.anchorPos);a[0]*=-l[0];a[1]*=-l[1];a[0]+=q.screenOffset[0]*f;a[1]+=q.screenOffset[1]*f;return a}function Z(q,l,f,a,b,d,c,g){l=l-b-(0<g[0]?a[0]*g[0]:0);let e=l+a[0]+2*b;f=f-b-(0<g[1]?a[1]*g[1]:0);b=f+a[1]+2*b;c.textureIsSignedDistanceField&&(c=c.distanceFieldBoundingBox,l+=a[0]*c[0],f+=a[1]*c[1],e-=a[0]*(1-c[2]),b-=a[1]*(1-c[3]),l-=d,e+=d,f-=d,b+=d);return q[0]>l&&q[0]<e&&q[1]>f&&q[1]<b}let xa=
function(q){function l(a){a=q.call(this,a,qa)||this;a.techniqueConfig=new L.HUDMaterialTechniqueConfiguration;return a}G._inheritsLoose(l,q);var f=l.prototype;f.getTechniqueConfig=function(a,b){this.techniqueConfig.output=a;this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.verticalOffset=!!this.params.verticalOffset;this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective;this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?
1:0;this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset;this.techniqueConfig.isDraped=this.params.isDraped;this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest;this.techniqueConfig.pixelSnappingEnabled=this.params.pixelSnappingEnabled;this.techniqueConfig.sdf=this.params.textureIsSignedDistanceField;this.techniqueConfig.vvSize=!!this.params.vvSizeEnabled;this.techniqueConfig.vvColor=!!this.params.vvColorEnabled;0===a&&(this.techniqueConfig.debugDrawBorder=!!this.params.debugDrawBorder);
4===a&&(this.techniqueConfig.binaryHighlightOcclusion=this.params.binaryHighlightOcclusion);this.techniqueConfig.depthEnabled=this.params.depthEnabled;this.techniqueConfig.transparencyPassType=b?b.transparencyPassType:3;this.techniqueConfig.multipassGeometryEnabled=b?b.multipassGeometryEnabled:!1;this.techniqueConfig.multipassTerrainEnabled=b?b.multipassTerrainEnabled:!1;this.techniqueConfig.cullAboveGround=b?b.cullAboveGround:!1;return this.techniqueConfig};f.intersect=function(a,b,d,c,g,e,p,m,h){h?
this.intersectDrapedHudGeometry(a,e,p,m):this.intersectHudGeometry(a,b,d,c,p,m)};f.intersectDrapedHudGeometry=function(a,b,d,c){const g=a.vertexAttributes.get("position"),e=a.vertexAttributes.get("size"),p=this.params,m=Y.calculateAnchorPosForRendering(p);let h=1;var r=1;N.isSome(c)&&(r=c(aa),h=r[0],r=r[5]);h*=a.screenToWorldRatio;r*=a.screenToWorldRatio;c=2*a.screenToWorldRatio;for(let t=0;t<g.data.length/g.size;t++){var v=t*g.size;const D=g.data[v];v=g.data[v+1];const z=t*e.size;A[0]=e.data[z]*
h;A[1]=e.data[z+1]*r;let w;p.textureIsSignedDistanceField&&(w=p.outlineSize*a.screenToWorldRatio/2);Z(b,D,v,A,c,w,p,m)&&d()}};f.intersectHudGeometry=function(a,b,d,c,g,e){if(c.options.selectionMode&&c.options.hud&&!na.isInstanceHidden(b)){b=this.params;var p=1,m=1;T.fromMat4(O,d);if(N.isSome(e)){m=e(aa);p=m[0];m=m[5];{e=O;var h=e[0],r=e[1],v=e[2],t=e[3],D=e[4],z=e[5],w=e[6],n=e[7],x=e[8],B=1/Math.sqrt(h*h+r*r+v*v);const F=1/Math.sqrt(t*t+D*D+z*z),P=1/Math.sqrt(w*w+n*n+x*x);e[0]=h*B;e[1]=r*B;e[2]=
v*B;e[3]=t*F;e[4]=D*F;e[5]=z*F;e[6]=w*P;e[7]=n*P;e[8]=x*P}}e=a.vertexAttributes.get("position");h=a.vertexAttributes.get("size");r=a.vertexAttributes.get("normal");a=a.vertexAttributes.get("auxpos1");la.assert(3<=e.size);v=c.point;t=c.camera;D=Y.calculateAnchorPosForRendering(b);p*=t.pixelRatio;m*=t.pixelRatio;z="screen"===this.params.centerOffsetUnits;for(w=0;w<e.data.length/e.size;w++)if(n=w*e.size,k.set(u,e.data[n],e.data[n+1],e.data[n+2]),k.transformMat4(u,u,d),n=w*h.size,A[0]=h.data[n]*p,A[1]=
h.data[n+1]*m,k.transformMat4(u,u,t.viewMatrix),n=w*a.size,k.set(y,a.data[n+0],a.data[n+1],a.data[n+2]),z||(u[0]+=y[0],u[1]+=y[1],0!==y[2]&&(n=y[2],k.normalize(y,u),k.subtract(u,u,k.scale(y,y,n)))),n=w*r.size,k.set(I,r.data[n],r.data[n+1],r.data[n+2]),this.normalAndViewAngle(I,O,t,Q),this.applyVerticalOffsetTransformationView(u,Q,t,R),t.applyProjection(u,E),-1<E[0]){n=Math.floor(E[0])+this.params.screenOffset[0];x=Math.floor(E[1])+this.params.screenOffset[1];z&&(n+=y[0],0!==y[1]&&(x+=K.applyScaleFactor(y[1],
R.factorAlignment)));K.applyPrecomputedScaleFactor(A,R.factor,A);B=1*t.pixelRatio;let F;b.textureIsSignedDistanceField&&(F=b.outlineSize*t.pixelRatio/2);Z(v,n,x,A,B,F,b,D)&&(x=c.ray,k.transformMat4(ba,u,ea.invert(ra,t.viewMatrix)),E[0]=v[0],E[1]=v[1],t.unprojectFromRenderScreen(E,u)&&(n=C.create(),k.copy(n,x.direction),B=1/k.length(n),k.scale(n,n,B),x=k.distance(x.origin,u)*B,g(x,n,-1,1,!0,ba)))}}};f.computeAttachmentOrigin=function(a,b){var d=a.vertexAttributes;if(!d)return!1;d=d.get("position");
a=a.indices.get("position");return ka.computeAttachmentOriginPoints(d,a,b)};f.createBufferWriter=function(){return new sa(this)};f.normalAndViewAngle=function(a,b,d,c){ha.isMat4(b)&&(b=T.fromMat4(ta,b));k.transformMat3(c.normal,a,b);k.transformMat4(c.normal,c.normal,d.viewInverseTransposeMatrix);c.cosAngle=k.dot(ca,ua);return c};f.updateScaleInfo=function(a,b,d){const c=this.params;c.screenSizePerspective?K.precomputeScaleFactor(d,b,c.screenSizePerspective,a.factor):(a.factor.scale=1,a.factor.factor=
0,a.factor.minPixelSize=0,a.factor.paddingPixels=0);c.screenSizePerspectiveAlignment?K.precomputeScaleFactor(d,b,c.screenSizePerspectiveAlignment,a.factorAlignment):(a.factorAlignment.factor=a.factor.factor,a.factorAlignment.scale=a.factor.scale,a.factorAlignment.minPixelSize=a.factor.minPixelSize,a.factorAlignment.paddingPixels=a.factor.paddingPixels)};f.applyShaderOffsetsView=function(a,b,d,c,g,e,p){b=this.normalAndViewAngle(b,d,g,Q);this.applyVerticalGroundOffsetView(a,b,g,p);this.applyVerticalOffsetTransformationView(p,
b,g,e);this.applyPolygonOffsetView(p,b,c[3],g,p);this.applyCenterOffsetView(p,c,p);return p};f.applyShaderOffsetsNDC=function(a,b,d,c,g){this.applyCenterOffsetNDC(a,b,d,c);N.isSome(g)&&k.copy(g,c);this.applyPolygonOffsetNDC(c,b,d,c);return c};f.applyPolygonOffsetView=function(a,b,d,c,g){var e=c.aboveGround?1:-1;d=M.sign(d);0===d&&(d=e);e*=d;if(0>=this.params.shaderPolygonOffset)return k.copy(g,a);b=M.clamp(Math.abs(b.cosAngle),.01,1);c=1-Math.sqrt(1-b*b)/b/c.viewport[2];0<e?k.scale(g,a,c):k.scale(g,
a,1/c);return g};f.applyVerticalGroundOffsetView=function(a,b,d,c){const g=k.length(a),e=d.aboveGround?1:-1;d=.5*d.computeRenderPixelSizeAtDist(g);b=k.scale(u,b.normal,e*d);k.add(c,a,b);return c};f.applyVerticalOffsetTransformationView=function(a,b,d,c){const g=this.params;if(!g.verticalOffset||!g.verticalOffset.screenLength){if(g.screenSizePerspective||g.screenSizePerspectiveAlignment){var e=k.length(a);this.updateScaleInfo(c,e,b.cosAngle)}else c.factor.scale=1,c.factorAlignment.scale=1;return a}e=
k.length(a);d=ma.verticalOffsetAtDistance(d,e,g.verticalOffset,b.cosAngle,g.screenSizePerspectiveAlignment||g.screenSizePerspective);this.updateScaleInfo(c,e,b.cosAngle);k.scale(b.normal,b.normal,d);return k.add(a,a,b.normal)};f.applyCenterOffsetView=function(a,b,d){const c="screen"!==this.params.centerOffsetUnits;d!==a&&k.copy(d,a);c&&(d[0]+=b[0],d[1]+=b[1],b[2]&&(k.normalize(I,d),k.add(d,d,k.scale(I,I,b[2]))));return d};f.applyCenterOffsetNDC=function(a,b,d,c){const g="screen"!==this.params.centerOffsetUnits;
c!==a&&k.copy(c,a);g||(c[0]+=b[0]/d.fullWidth*2,c[1]+=b[1]/d.fullHeight*2);return c};f.applyPolygonOffsetNDC=function(a,b,d,c){const g=this.params.shaderPolygonOffset;a!==c&&k.copy(c,a);g&&(a=d.aboveGround?1:-1,b=a*M.sign(b[3]),c[2]-=(b||a)*g);return c};f.getGLMaterial=function(a){if(0===a.output||7===a.output)return new va(a);if(4===a.output)return new wa(a)};f.calculateRelativeScreenBounds=function(a,b,d=ia.create()){oa(this.params,a,b,d);d[2]=d[0]+a[0];d[3]=d[1]+a[1];return d};return l}(X.Material);
J=function(q){function l(a){a=q.call(this,{...a,...a.material.params})||this;a.updateParameters();return a}G._inheritsLoose(l,q);var f=l.prototype;f.beginSlot=function(a){return a===(this._material.params.drawInSecondSlot?19:18)};f.updateParameters=function(a){this.updateTexture(this._material.params.textureId);this.selectProgram(a)};f.selectProgram=function(a){this._technique=this._techniqueRep.releaseAndAcquire(L.HUDMaterialTechnique,this._material.getTechniqueConfig(this._output,a),this._technique)};
f.ensureParameters=function(a){this.updateParameters(a)};f.bind=function(a){this.bindTextures(this._technique.program);this.bindTextureScale(this._technique.program);this._technique.bindPass(this._material.params,a)};return l}(J);let va=function(q){function l(a){a=q.call(this,a)||this;a._isOcclusionSlot=!1;return a}G._inheritsLoose(l,q);var f=l.prototype;f.beginSlot=function(a){const b=this._material.params.drawInSecondSlot?19:18;if(this._material.params.occlusionTest)return this._isOcclusionSlot=
12===a,12===a||a===b;this._isOcclusionSlot=!1;return a===b};f.selectProgram=function(a){this._technique=this._techniqueRep.releaseAndAcquire(L.HUDMaterialTechnique,this._material.getTechniqueConfig(this._output,a),this._technique);this._occlusionTechnique=this._techniqueRep.releaseAndAcquire(L.HUDMaterialTechnique,this._material.getTechniqueConfig(6,a),this._occlusionTechnique)};f.bind=function(a){const b=this.technique;this._isOcclusionSlot||(this.bindTextures(b.program),this.bindTextureScale(b.program));
b.bindPass(this._material.params,a)};G._createClass(l,[{key:"technique",get:function(){return this._isOcclusionSlot?this._occlusionTechnique:this._technique}}]);return l}(J),wa=function(q){function l(f){return q.call(this,{...f,output:4})||this}G._inheritsLoose(l,q);return l}(J);const R={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},pa=W.create(),u=C.create(),I=C.create(),E=da.createRenderScreenPointArray3(),ca=C.create(),
ba=C.create(),O=U.create(),ta=U.create(),ra=V.create(),y=C.create(),Q={normal:ca,cosAngle:0},aa=V.create(),A=[0,0],ua=C.fromValues(0,0,1),qa={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],
vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:W.fromValues(.5,.5),shaderPolygonOffset:1E-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawBorder:!1,isDraped:!1,...X.materialParametersDefaults},ya=ja.newLayout().vec3f("position").vec3f("normal").vec2f("uv0").vec4u8("color").vec2f("size").vec4f("auxpos1").vec4f("auxpos2");
let sa=function(){function q(f){this.material=f;this.vertexBufferLayout=ya}var l=q.prototype;l.allocate=function(f){return this.vertexBufferLayout.createBuffer(f)};l.elementCount=function(f){return 6*f.indices.get("position").length};l.write=function(f,a,b,d){H.writePosition(a.indices.get("position"),a.vertexAttributes.get("position").data,f.transformation,b.position,d,6);H.writeNormal(a.indices.get("normal"),a.vertexAttributes.get("normal").data,f.invTranspTransformation,b.normal,d,6);var c=a.vertexAttributes.get("uv0").data;
if(null==c||4>c.length){c=this.material.params;var g=f=0;var e=c.texCoordScale[0];c=c.texCoordScale[1]}else f=c[0],g=c[1],e=c[2],c=c[3];e=Math.min(1.99999,e+1);c=Math.min(1.99999,c+1);var p=a.indices.get("position").length,m=b.uv0,h=d;for(var r=0;r<p;++r)m.set(h,0,f),m.set(h,1,g),h+=1,m.set(h,0,e),m.set(h,1,g),h+=1,m.set(h,0,e),m.set(h,1,c),h+=1,m.set(h,0,e),m.set(h,1,c),h+=1,m.set(h,0,f),m.set(h,1,c),h+=1,m.set(h,0,f),m.set(h,1,g),h+=1;H.writeColor(a.indices.get("color"),a.vertexAttributes.get("color").data,
4,b.color,d,6);f=a.indices.get("size");g=a.vertexAttributes.get("size").data;e=f.length;c=b.size;p=d;for(m=0;m<e;++m){h=g[2*f[m]];r=g[2*f[m]+1];for(let v=0;6>v;++v)c.set(p,0,h),c.set(p,1,r),p+=1}a.indices.get("auxpos1")&&a.vertexAttributes.get("auxpos1")&&H.writeBufferVec4(a.indices.get("auxpos1"),a.vertexAttributes.get("auxpos1").data,b.auxpos1,d,6);a.indices.get("auxpos2")&&a.vertexAttributes.get("auxpos2")&&H.writeBufferVec4(a.indices.get("auxpos2"),a.vertexAttributes.get("auxpos2").data,b.auxpos2,
d,6)};return q}();S.HUDMaterial=xa;Object.defineProperty(S,"__esModule",{value:!0})});