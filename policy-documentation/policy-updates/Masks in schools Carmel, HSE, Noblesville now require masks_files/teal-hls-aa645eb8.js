window.Teal=window.Teal||{};class HLS{constructor(s,t){this.ready=t,this.parent=s,this._loaded=new Promise((s,t)=>{this.parent.settings.hls.load&&!window.Hls?this.load(s,t):window.Hls&&(this.init(),s())})}async load(s,t){try{await Teal.Utils.loadAndWaitForInit(this.parent.settings.hls.scriptUrl,"hls","Hls"),this.init(),s()}catch(s){this.parent._mp4Fallback(),t()}}init(){this.hls=new Hls({maxBufferSize:this.parent.settings.hls.maxBufferSize,maxMaxBufferLength:this.parent.settings.hls.maxMaxBufferLength}),this._hlsEvents(),this.ready()}_hlsEvents(){let s=(t,e)=>{(e.fatal||e.response&&404===e.response.code)&&(this.hls.off(Hls.Events.ERROR,s),e.context&&"subtitleTrack"!==e.context.type&&this.parent._mp4Fallback())};this.hls.on(Hls.Events.ERROR,s);let t=0;this.hls.on(window.Hls.Events.FRAG_LOADED,()=>{let s=this.hls.currentLevel>=0?this.hls.levels[this.hls.currentLevel].bitrate:0;Teal.Utils.UA.isMobile||(0===t&&(this.hls.loadLevel=-1),t++),this.parent.sm.bitRate!==s&&(this.parent.sm.bitRate=s)})}_videoLoad(){return this.hls||this.init(),new Promise((s,t)=>{this._loaded.then(()=>{this.parent.sm.hlsLoaded=!0,this.hls.loadSource(this.parent.data.hlsURL),this.hls.attachMedia(this.parent.elements.video),this.hls.on(Hls.Events.MANIFEST_PARSED,(t,e)=>{Teal.Utils.UA.isMobile||(this.hls.loadLevel=e.levels.length-1),s()}),this.hls.on(Hls.Events.SUBTITLE_TRACKS_UPDATED,(s,t)=>{t.subtitleTracks&&t.subtitleTracks[0]&&(t.subtitleTracks[0].default=!0)}),this.hls.on(Hls.Events.SUBTITLE_TRACK_LOADED,s=>{this.parent.sm.notifyEvent(this.parent.sm.EVENTS.subtitletrackadded)})})})}destroy(){this.hls&&(this.hls.destroy(),this.hls=null)}}window.Teal.HLS=HLS;