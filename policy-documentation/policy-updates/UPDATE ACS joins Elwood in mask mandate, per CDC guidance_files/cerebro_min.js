var WORK_SERVER="https://edge-mcdn.secure.yahoo.com/ybar/exp.json",TIMEOUT=2e3,Cerebro=function(){function e(){this.uploadType="individual",this.expCount=0,this.pending={},this.complete=0}return e.runExperiment=function(){(new e)._fetchWork()},e.sendBeacon=function(){this.runExperiment()},e.prototype._extractResourceTiming=function(n){var t="",t="[";return["startTime","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","secureConnectionStart","connectEnd","requestStart","responseStart","responseEnd"].forEach(function(e){t+=n[e]+","}),t=t.slice(0,-1)+"]"},e.prototype._extractHeader=function(n,e){if(0==e.length)return"{}";var t="{";return e.forEach(function(e){t+='"'+e+'":"'+n.getResponseHeader(e)+'",'}),t=t.slice(0,-1)+"}"},e.prototype._fetchWork=function(){var n=this,o=!1;new Promise(function(n,t){var r=setTimeout(function(){o=!0,t(new Error("Work Order Request Timed Out"))},TIMEOUT);fetch(WORK_SERVER).then(function(e){clearTimeout(r),o||n(e)}).catch(function(e){o||t(e)})}).then(function(e){return e.json()}).then(function(e){n._parseWork(e)}).catch(function(e){})},e.prototype._parseWork=function(e){var n=e.expCount,t=e.selection;this.uploadType=e.uploadType;var r=[],o=[];if(0!==n){if(n>=e.expList.length)o=e.expList;else if("random"===t)for(var i=0;i<n;i++)(a=Math.floor(Math.random()*(e.expList.length+1)))===e.expList.length&&(a-=1),o.push(e.expList[a]);else if("ordered"===t){(a=Math.floor(Math.random()*(e.expList.length+1)))===e.expList.length&&(a-=1);for(i=0;i<n;i++)a+i>=e.expList.length&&(a=-1*i),o.push(e.expList[a+i])}else if("individual"===t)for(var a=100*Math.random(),s=0,u=e.expList;s<u.length;s++){var c=u[s];e.runProb<a&&o.push(c)}for(var p=0,l=o;p<l.length;p++)for(c=l[p],i=0;i<c.trials;i++){var a=Math.ceil(99999999999999*Math.random()).toString(36),d=c.target.replace("<RAND>",a),f=new RegExp(c.beaconRegex,"gi").exec(d),h=[],m=[];c.requestHeaders&&(h=c.requestHeaders),c.parseHeaders&&(m=c.parseHeaders),null!==f&&null!==f[1]?r.push([d,f[1],c.timeout,h,m,c.name,c.uploadEndpoints]):r.push([d,c.name,c.timeout,h,m,c.name,c.uploadEndpoints]),this.expCount++}this._sendBeacons(r)}},e.prototype._sendBeacons=function(e){for(var m=this,n=function(){this.startTime=0,this.endTime=0,this.source="default"},t=0,r=e;t<r.length;t++){var o=r[t];!function(o,i,a,r,s,u,c){var p,l,d,f,h;0<s.length||0<r.length?(l=new n,d=!1,new Promise(function(e,n){var t=setTimeout(function(){d=!0,n(new Error("Header Request Timed Out"))},a);(p=new XMLHttpRequest).open("GET",o,!0),p.onload=function(){clearTimeout(t),d||e()},p.onerror=function(){clearTimeout(t),d||e()},r.forEach(function(e){e=e.split(":");2==e.length&&p.setRequestHeader(e[0],e[1])}),l.startTime=Date.now(),p.send()}).then(function(){if("performance"in window&&"getEntriesByType"in window.performance){l.endTime=Date.now(),l.source="ajax";var e=window.performance.getEntriesByName(o);m.expCount=1<e.length?m.expCount+e.length-1:m.expCount;for(var n=0,t=e;n<t.length;n++){var r=t[n];m._sendClientMeasurements("0",i,r,m._extractHeader(p,s),u,c,l)}}else m._sendClientMeasurements("6",i,null,m._extractHeader(p,s),u,c,l)}).catch(function(e){d?m._sendClientMeasurements("5",i,null,"",u,c,l):m._sendClientMeasurements("4",i,null,"",u,c,l)})):(f=!1,h=new n,new Promise(function(e,n){var t=setTimeout(function(){f=!0,n(new Error("Experiment Timed Out"))},a),r=new Image;r.onload=function(){clearTimeout(t),f||e()},r.onerror=function(){clearTimeout(t),f||e()},h.startTime=Date.now(),r.src=o}).then(function(){if("performance"in window&&"getEntriesByType"in window.performance){h.endTime=Date.now(),h.source="image";var e=window.performance.getEntriesByName(o);m.expCount=1<e.length?m.expCount+e.length-1:m.expCount;for(var n=0,t=e;n<t.length;n++){var r=t[n];m._sendClientMeasurements("0",i,r,"",u,c,h)}}else m._sendClientMeasurements("3",i,null,"",u,c,h)}).catch(function(e){f?m._sendClientMeasurements("2",i,null,"",u,c,h):m._sendClientMeasurements("1",i,null,"",u,c,h)}))}(o[0],o[1],o[2],o[3],o[4],o[5],o[6])}},e.prototype._sendClientMeasurements=function(e,n,t,r,o,i,a){var s,u,c,p,l=this;0!==i.length&&(s=function(r,o){var n=0;new Promise(function(e,n){var t=new Image;t.onload=function(){return e()},t.onerror=function(){return n()},t.src=r[0]+o}).catch(function(e){(n+=1)<r.length&&s(r[n],o)})},u="{",null!=o&&(u+='"n":"'+o+'",'),u+=null===t?'"m":[],':'"m":'+this._extractResourceTiming(t)+",",u+='"r":'+e+",",u+='"s":'+a.startTime+",",u+='"e":'+a.endTime+",",u+='"q":"'+a.source+'",',""!=r&&(u+='"h":'+r+","),window.YBAR&&"function"==typeof window.YBAR.getConfig&&(u+='"p":"'+window.YBAR.getConfig().property+'",',u+='"d":"'+window.YBAR.getConfig().device+'",',u+='"l":"'+window.YBAR.getConfig().locale+'",'),u+='"b":"'+n+'"}',c="",p=[],i.forEach(function(e){c+=e.replace("<BEACON>",n),p.push(e.replace("<BEACON>",n))}),"group"==this.uploadType?(c in this.pending||(this.pending[c]=[]),this.pending[c].push([u,p]),this.complete++,this.complete==this.expCount&&Object.keys(this.pending).forEach(function(e){var n,t="[";l.pending[e].forEach(function(e){t+=e[0]+",",n=e[1]}),t=t.slice(0,-1)+"]",s(n,btoa(t))})):(u="["+u+"]",s(p,btoa(u))))},e}();Cerebro.runExperiment();