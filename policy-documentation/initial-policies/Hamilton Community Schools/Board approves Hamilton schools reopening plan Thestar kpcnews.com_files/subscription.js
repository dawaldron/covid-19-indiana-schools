window.TNCMS=window.TNCMS||{},window.TNCMS.Subscription=function(){"use strict";function n(n){console&&console.debug&&console.debug(n)}function e(n,e,t){var i,r;for(i=0,r=n.length;i<r;i++)e.call(t,i,n[i])}function t(n){for(var e=n+"=",t=document.cookie.split(";"),i=0,r=t.length;i<r;i++){for(var c=t[i];" "==c.charAt(0);)c=c.substring(1,c.length);if(0==c.indexOf(e))return c.substring(e.length,c.length)}return null}function i(n){return n&&!n.propertyIsEnumerable("length")&&"object"==typeof n&&"number"==typeof n.length}function r(n){if(!i(n)&&n&&"string"==typeof n&&-1!==n.indexOf(_)&&(n=n.split(_).join(O)),!i(n)&&n&&"string"==typeof n&&(n=n.split(O)),i(n))return n}function c(){return null===M&&(M=!!E),M}function l(){return!!b}function o(){return null===k&&(TNCMS.User.isLoggedIn()&&(L=r(t("tncms-services"))),!1===(k=!!L)&&(y=!1,C=!1,R=[],L=[])),k}function u(){if(null===w){if(!0===o()){R=[];for(var n=0,e=L.length;n<e;n++){var t=L[n];if(0!=t)for(var r=0,c=E.length;r<c;r++)t==E[r]&&(R=R.concat(t));else null===y&&(y=!0)}null===y&&(y=!1)}y?(C=!1,R.length=0):null===C&&(C=i(R)&&R.length>0),w=y||C}return w}function s(){return null===C&&u(),C}function a(){return null===y&&u(),y}function f(){return s()?R.slice(0,1):[]}function d(){return null===S&&(S=!c()||(l()||u()||!1)),S}function g(){return null===T&&(T=!!c()&&s()),T}function p(){return null===I&&(I=N?o()||!1:g()||!1)&&TNCMS&&TNCMS.Tracking&&TNCMS.Tracking.addData&&TNCMS.Tracking.addEvent&&(q=document.querySelectorAll('meta[name^="x-tncms-aam-"]'),q&&e(q,function(n,e){e&&e.content&&e.name&&e.name.length&&e.name.length>=12&&TNCMS.Tracking.addData({name:e.name.substring(12,e.name.length),value:e.content})}),TNCMS.Tracking.addEvent({app:"subscription",metric:"view",id:f()})),I}function v(){var n;if(null!==D){for(c(),o(),u(),s(),a(),d(),g(),p();D.length>0;)n=D.shift(),n[0].call(n[1]||null,j);D=null}}function h(n,e){null===D?n.call(e||null,j):D.push([n,e])}function m(e){var t;if(e=e||{},!e.service_id)return void(console.warn&&console.warn("Missing required config: service_id"));if(E=r(e.service_id),!i(E))return void(console.warn&&console.warn("Invalid config: service_id"));t=e.prefix||"",N=!!e.unrestricted;try{H=new XMLHttpRequest}catch(n){}if(!H)return void v();H.addEventListener("timeout",v),H.addEventListener("error",v),H.addEventListener("load",function(){var n,e;if(200==H.status||304==H.status){if((n=H?H.getResponseHeader("Content-Type"):null)&&"application/json"===n.replace(/;.*/,"").toLowerCase())try{e=JSON.parse(H.responseText)}catch(n){e=void 0}b=!!e.whitelist,x=e.error||null}v()}),H.open("GET",t+"/tncms/subscription/check_ip/",!0),H.setRequestHeader("X-Requested-With","XMLHttpRequest"),H.timeout=1e3;try{H.send(null)}catch(n){v()}document&&window.fetch&&localStorage&&(localStorage.getItem("tncms:subscription:cp")||localStorage.setItem("tncms:subscription:cp",new Date),document.addEventListener("visibilitychange",function(){if(TNCMS.User.isLoggedIn()){var e=new Date;try{if(-1!=document.cookie.indexOf("tncms-services")){if(e-new Date(localStorage.getItem("tncms:subscription:cp"))<144e5)return void n("Subscription verification check skipped: check under 4 hours")}else n("Subscription service cookie missing - checking for update")}catch(e){n("Subscription verification check failed: "+e.message)}n("Subscription verification check initiated"),localStorage.setItem("tncms:subscription:cp",e),fetch(t+"/tncms/subscription/activate/?interactive=no",{method:"POST"})}}))}var S=null,b=null,w=null,T=null,k=null,y=null,C=null,M=null,N=null,I=null,E=null,L=null,R=null,q=null,x="Failed to initialize",D=[],H=null,O=",",_="%2C",j={isRestricted:function(){return M},accessByIpError:function(){return x},accessByIp:function(){return!!b},allowAccess:function(){return!!S},userHasService:function(){return T}};return{initialize:m,onReady:h}}();
//# sourceMappingURL=subscription.js.map