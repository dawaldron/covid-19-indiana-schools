window.Teal=window.Teal||{};class IMA{constructor(t,e){this.parent=t,this.ready=e,this.isSkippable=!1,!this.parent.settings.ima.load||window.google&&window.google.ima?window.google&&window.google.ima&&this.init():this.load()}async load(){try{await Teal.Utils.loadScript("ima",this.parent.settings.ima.scriptUrl),this.init()}catch(t){this.parent._disablePreroll(),this.ready.reject()}}init(){Teal.Utils.waitForInit("google").then(()=>{google.ima.settings.setDisableCustomPlaybackForIOS10Plus(!0);let t=(this.parent.settings.ima.vpaidMode||"ENABLED").toUpperCase();google.ima.settings.setVpaidMode(google.ima.ImaSdkSettings.VpaidMode[t]),this.parent.adDisplayContainer||this._createDisplayContainer(),this._createAdsLoader(),this._loadIAS(),this._resetAdPlusFlags(),Teal.Utils._registerEvents(this,[{event:"resize",handler:Teal.Utils.debounce(()=>{this._adResize()},100)}],window),this.ready.resolve()},()=>{this.parent._disablePreroll(),this.ready.reject()})}_initIAS(){if(!this.iasLoaded)return;let t={anId:this.parent.settings.ias.anId,campId:`${this.parent.elements.adContainer.offsetWidth}x${this.parent.elements.adContainer.offsetHeight}`,partner:this.parent.settings.ias.partner};window.googleImaVansAdapter.init(window.google,this.adsManager,this.parent.elements.adContainer,t)}_loadIAS(){this.parent.settings.ias.enable&&(this.parent.settings.ias.load?Teal.Utils.loadAndWaitForInit(this.parent.settings.ias.scriptUrl,"tealplayer_ias","googleImaVansAdapter").then(()=>{this.iasLoaded=!0}).catch(()=>{}):Teal.Utils.waitForInit("googleImaVansAdapter").then(()=>{this.iasLoaded=!0}))}_createDisplayContainer(){this.parent.adDisplayContainer=new google.ima.AdDisplayContainer(this.parent.elements.adContainer,this.parent.elements.video)}_createAdsLoader(){this.adsLoader=new google.ima.AdsLoader(this.parent.adDisplayContainer);let t=[{event:google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,handler:this._onAdsManagerLoaded},{event:google.ima.AdErrorEvent.Type.AD_ERROR,handler:this._onError}];Teal.Utils._registerEvents(this,t,this.adsLoader)}_onAdsManagerLoaded(t){let e=new google.ima.AdsRenderingSettings;e.restoreCustomPlaybackStateOnAdBreakComplete=!0,e.loadVideoTimeout=-1,this.adsManager=t.getAdsManager(this.parent.elements.video,e),this._setMute(),this.parent.sm.setPrerollState(this.parent.sm.states.READY),this._initIAS(),this._setupListeners(),this._start()}_kickoff(){this.parent.sm.setPrerollState(this.parent.sm.states.LOADING),this.parent.sm.adDisplayInitialized||this.parent.adDisplayContainer.initialize();const t=this._createAdRequest();this.adsLoader.requestAds(t),this.parent.sm.imaKickedOff=!0}_play(){this.adsManager&&this.adsManager.resume()}_pause(){this.adsManager&&this.adsManager.pause()}_start(){this.adsManager.init(this.parent.elements.adContainer.offsetWidth,this.parent.elements.adContainer.offsetHeight,google.ima.ViewMode.NORMAL),this.adsManager.start()}_createAdRequest(){const t=new google.ima.AdsRequest;return t.adTagUrl=this._buildCall(),t.linearAdSlotWidth=640,t.linearAdSlotHeight=400,this.parent.settings.ima.overridePageUrl&&(t.pageUrl=this.parent.settings.ima.overridePageUrl),0===this.parent.sm.playbackIndex&&this.parent.settings.base.startMuted&&(t.setAdWillAutoPlay(!0),t.setAdWillPlayMuted(!0)),t}_setupListeners(){let t=[{event:google.ima.AdError.Type.AD_LOAD,handler:this._onError},{event:google.ima.AdError.Type.AD_PLAY,handler:this._onError},{event:google.ima.AdErrorEvent.Type.AD_ERROR,handler:this._onError},{event:google.ima.AdEvent.Type.CLICK,handler:this._onClick},{event:google.ima.AdEvent.Type.STARTED,handler:this._onStart},{event:google.ima.AdEvent.Type.COMPLETE,handler:this._onComplete},{event:google.ima.AdEvent.Type.ALL_ADS_COMPLETED,handler:this._onComplete},{event:google.ima.AdEvent.Type.SKIPPED,handler:this._onSkip},{event:google.ima.AdEvent.Type.LOADED,handler:this._onLoaded},{event:google.ima.AdEvent.Type.PAUSED,handler:this._onPause},{event:google.ima.AdEvent.Type.RESUMED,handler:this._onPlay},{event:google.ima.AdEvent.Type.IMPRESSION,handler:this._onImpression},{event:google.ima.AdEvent.Type.LOG,handler:this._onLog},{event:google.ima.AdEvent.Type.VOLUME_CHANGED,handler:this._setMute}];Teal.Utils._registerEvents(this,t,this.adsManager)}_adHasOwnSkip(){if(!this.ad)return;let t;try{t=Teal.Utils.getNested(JSON.parse(this.ad.getTraffickingParametersString()||"{}"),"capabilities","skipButton")}catch(e){t=!1}return this.ad.isSkippable()||t}_adResize(){let t,e=Teal.Utils.getNested(window.google,"ima","ViewMode","NORMAL")||"normal";this.parent.sm.fullscreen?(t=window.innerWidth,e=Teal.Utils.getNested(window.google,"ima","ViewMode","FULLSCREEN")||"fullscreen"):t=Math.floor(this.parent.elements.container.offsetWidth),this._resize(t,.5625*t,e)}_resize(t,e,s){this.adsManager&&this.adsManager.resize(t,e,s)}_setMute(){this.parent.isMuted&&this._setVolume(0)}_setSkipState(){if(this.isSkippable&&!this._adHasOwnSkip()&&this.adsManager)return!!(this.adCount&&this.adCount>1)||this.adData.duration-this.parent.settings.ima.userWaitTime>=this.remainingTime&&this.remainingTime>0}_setVolume(t){this.adsManager&&this.adsManager.setVolume(t)}_onClick(){this.parent.sm.state===this.parent.sm.states.PLAYING&&this.parent.pause()}_onError(t){this.adFailures+=1,this._onComplete(t)}_onStart(){this.parent.elements.adContainer.style.visibility="",this.parent.sm.setPrerollState(this.parent.sm.states.STARTED),this.parent.sm.setPrerollState(this.parent.sm.states.PLAYING)}_resetAdPlusFlags(){this._adPlusEnabled&&(this.adFailures=this.adCount=0)}_disableAdPlus(){this._adPlusEnabled&&(this._resetAdPlusFlags(),this.adPlusComplete=this.parent.settings.ima.adPlusEnabled=!1)}get _adPlusEnabled(){return this.parent.settings.ima.adPlusEnabled}get _supportsAdPlus(){if(document.hidden||!this._adPlusEnabled)return;let t=!1,e=this.parent.settings.ima.adPlusMaxFailures,s=this.parent.settings.ima.adPlusMaxRequests,a=this.adFailures<e,i=this.adCount<s;return t=!!(this.parent.sm.playbackIndex===this.parent.settings.ima.adPlusRequiredPlays&&a&&i)}_onComplete(t){let e=t&&t.type?t.type:"";e===google.ima.AdEvent.Type.SKIPPED&&this._disableAdPlus(),this._adPlusEnabled&&this.adCount===this.parent.settings.ima.adPlusMaxRequests&&this._disableAdPlus(),this._supportsAdPlus?e===google.ima.AdEvent.Type.COMPLETE||e===google.ima.AdEvent.Type.ALL_ADS_COMPLETED?this.adPlusComplete||(this.adPlusComplete=!0,this.parent.sm.setPrerollState(this.parent.sm.states.DONE),this.parent.sm.notifyEvent(this.parent.sm.EVENTS.adPlusComplete),this._kickoff()):[google.ima.AdError.Type.AD_LOAD,google.ima.AdError.Type.AD_PLAY,google.ima.AdErrorEvent.Type.AD_ERROR].indexOf(e)>=0&&this._kickoff():(this.parent.sm.setPrerollState(this.parent.sm.states.DONE),this.parent.elements.adContainer.style.visibility="hidden",this._destroyAds(),this._resetAdPlusFlags())}_onSkip(t){this.parent.sm.notifyEvent(this.parent.sm.EVENTS.skip),this._disableAdPlus(),this._onComplete(t)}_onLoaded(t){this.ad=t.getAd(),this.adData=t.getAdData(),"videostop"===this.adData.title.toLowerCase()&&this._disableAdPlus(),this.isSkippable=this._supportsAdPlus&&this.adCount>=1||this.adData.duration>this.parent.settings.ima.requiredSkipAdLength}_onPause(){this.parent.sm.setPrerollState(this.parent.sm.states.PAUSED)}_onPlay(){this.parent.sm.setPrerollState(this.parent.sm.states.PLAYING)}_onImpression(){this._supportsAdPlus&&(this.adCount+=1),this.adFailures=0}_onLog(t){}_buildTestCall(){return"https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/single_ad_samples&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=deployment%3Ddevsite%26sample_ct%3Dskippablelinear&correlator="}_buildCall(){if(this.parent.settings.ima.url)return this.parent.settings.ima.url;let t=new URLSearchParams(window.location.search);if(t.has("tealadurl"))return window.decodeURI(t.get("tealadurl"));let e="https://pubads.g.doubleclick.net/gampad/ads?";return this.parent.settings.ima.targetingConsent||(e+="rdp=1"),e+=this._buildParams(this._getRequiredParams()),e+=`&cust_params=${encodeURIComponent(this._buildParams(this._getCustParams()))}`}_buildParams(t){return Object.keys(t).reduce((e,s)=>e+`&${s}=${t[s]}`,"")}_getRequiredParams(){let t=this.parent.data;return{ad_rule:0,cmsid:12768,description_url:t.pageURL.long,env:"vp",gdfp_req:1,hl:"en",iu:this._getIU(),output:"xml_vast4",scp:this._getSCP(),sz:this._getSZ(),unviewed_position_start:1,url:window.location.href.indexOf("#")>-1?window.location.href.slice(0,window.location.href.indexOf("#")):window.location.href,vid:t.id}}_getIU(){let t=Teal.Utils.UA.isMobile?this.parent.settings.ima.mobileAccountName:this.parent.settings.ima.accountName;return`/${this.parent.settings.ima.accountId}/${t}/${this._getPlacement()}/${this.parent.data.awsPath}`}_getSZ(){return Teal.Utils.UA.isMobile?this.parent.settings.ima.mobileSize:this.parent.settings.ima.desktopSize}_getPlacement(){return Teal.Utils.UA.isMobile?this.parent.settings.ima.mobilePlacement:this.parent.settings.ima.placement}_getSCP(){return this.scp}_getPrebidParams(){return this.prebidParams}get duration(){return this.adData?this.adData.duration:0}get remainingTime(){return this.adsManager&&this.adData&&this.adsManager.getRemainingTime()}get startedBy(){let t="auto-continuous";return 0===this.parent.sm.playbackIndex&&(t=this.parent.settings.base.startedBy),this._adPlusEnabled&&this.adCount>=1&&(t=`auto-${this.parent.settings.ima.adPlusCampaign}`),t}_getCustParams(){let t=this.parent.pageData.adTargeting.simpleTarget,[e="",s="",a=""]=this.parent.data.awsPath?this.parent.data.awsPath.split("/"):[],[i="",n="",r=""]=this.parent.pageData.awsPath?this.parent.pageData.awsPath.split("/"):[],d={adCount:this._supportsAdPlus&&this.adCount>0?this.adCount:"",categoryvalue:t.filter(Boolean).join(","),contentid:this.parent.data.id,credit:this.parent.data.byline,cst_section:Teal.Utils.joinStrings(i,e),cst_subsection:Teal.Utils.joinStrings(n,s),cst_topic:Teal.Utils.joinStrings(r,a),mutedAutoplay:this.parent.isMuted,origin:this.parent.data.origin,pagetype:this.parent.pageData.pageType,playersize:`${this.parent.elements.container.offsetWidth}x${this.parent.elements.container.offsetHeight}`,playertype:this.parent.settings.base.placement,recommendedvideo:this.parent._recommendation||"",series:Teal.Utils.joinStrings(this.parent.pageData.series,this.parent.data.series),ssts_section:Teal.Utils.joinStrings(this.parent.pageData.section,this.parent.data.ssts.section),ssts_subsection:Teal.Utils.joinStrings(this.parent.pageData.subsection,this.parent.data.ssts.subsection),ssts_topic:Teal.Utils.joinStrings(this.parent.pageData.topic,this.parent.data.ssts.topic),ssts_subtopic:Teal.Utils.joinStrings(this.parent.pageData.subtopic,this.parent.data.ssts.subtopic),topic:`${this.parent.pageData.keywords},${this.parent.data.keywords}`.replace(/\s|\+/g,"-").toLowerCase()||"NA",variant:this.parent.data.variant||"",vfront:this.parent.pageData.vfront||"",vfrontsec:this.parent.pageData.vfrontsec||"",videolength:this.parent.data.length,videotag:Teal.Utils.tagsToString(this.parent.data.tags),videostart:this.startedBy};return this.parent.settings.ima.gdprApplies&&(d.gdpr=+this.parent.settings.ima.gdprApplies,d.gdpr_consent=this.parent.settings.ima.tcString),Object.assign({},d,this._getPrebidParams(),this.parent.pageData.adTargeting.customParams||{})}_destroyAds(){this.adsManager&&(this.adsManager.stop(),this.adsManager.destroy(),this.adsManager=null),this.adData&&(this.adData="")}_setPrebidBids(t){this.prebidParams={},t.forEach(t=>{let e=t.bidderCode;if("bid available"===t.statusMessage.toLowerCase()){Object.keys(t.adserverTargeting).filter(t=>t.indexOf("hb_")>-1).forEach(s=>{let a=`${s}_${e}`.substring(0,20),i=t.adserverTargeting[s];this.prebidParams[a]=i});let s=`hb_uuid_${e}`.substring(0,20);this.prebidParams[s]=t.videoCacheKey||t.impression_id}})}_setA9Params(t){this.scp=t}skip(){this._onSkip()}adResize(){this._adResize()}}window.Teal.IMA=IMA;